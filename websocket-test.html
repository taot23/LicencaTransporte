<!DOCTYPE html>
<html>
<head>
    <title>Teste WebSocket - Servidor Google</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .error { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 15px; height: 300px; overflow-y: auto; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <h1>Teste de Conectividade WebSocket</h1>
    
    <div id="status" class="status disconnected">Desconectado</div>
    
    <div>
        <button onclick="connectWebSocket()">Conectar WebSocket</button>
        <button onclick="disconnectWebSocket()">Desconectar</button>
        <button onclick="clearLog()">Limpar Log</button>
        <button onclick="testHttp()">Testar HTTP</button>
    </div>
    
    <h3>URLs testadas:</h3>
    <div id="urls"></div>
    
    <h3>Log de eventos:</h3>
    <div id="log"></div>

    <script>
        let socket = null;
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const urlsDiv = document.getElementById('urls');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status, className) {
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }
        
        function testUrls() {
            const hostname = window.location.hostname;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            
            const urls = [
                `ws://${hostname}:5000/ws`,
                `ws://${hostname}/ws`,
                `wss://${hostname}:5000/ws`,
                `wss://${hostname}/ws`,
                `ws://localhost:5000/ws`,
                `ws://127.0.0.1:5000/ws`
            ];
            
            urlsDiv.innerHTML = urls.map(url => `<div>‚Ä¢ ${url}</div>`).join('');
            return urls;
        }
        
        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                log('WebSocket j√° est√° conectado');
                return;
            }
            
            const urls = testUrls();
            tryNextUrl(urls, 0);
        }
        
        function tryNextUrl(urls, index) {
            if (index >= urls.length) {
                log('‚ùå Todos os URLs falharam');
                updateStatus('Erro: Nenhuma URL funcionou', 'error');
                return;
            }
            
            const url = urls[index];
            log(`üîÑ Tentando conectar: ${url}`);
            
            try {
                socket = new WebSocket(url);
                
                const timeout = setTimeout(() => {
                    if (socket.readyState === WebSocket.CONNECTING) {
                        log(`‚è±Ô∏è  Timeout para ${url}`);
                        socket.close();
                        tryNextUrl(urls, index + 1);
                    }
                }, 3000);
                
                socket.onopen = () => {
                    clearTimeout(timeout);
                    log(`‚úÖ Conectado com sucesso: ${url}`);
                    updateStatus(`Conectado: ${url}`, 'connected');
                };
                
                socket.onmessage = (event) => {
                    log(`üì® Mensagem recebida: ${event.data}`);
                };
                
                socket.onclose = (event) => {
                    clearTimeout(timeout);
                    log(`‚ùå Conex√£o fechada: ${url} (c√≥digo: ${event.code})`);
                    if (index === 0) { // S√≥ tenta pr√≥ximo se for a primeira tentativa
                        tryNextUrl(urls, index + 1);
                    } else {
                        updateStatus('Desconectado', 'disconnected');
                    }
                };
                
                socket.onerror = (error) => {
                    clearTimeout(timeout);
                    log(`‚ùå Erro na conex√£o: ${url}`);
                    tryNextUrl(urls, index + 1);
                };
                
            } catch (error) {
                log(`‚ùå Erro ao criar WebSocket: ${error.message}`);
                tryNextUrl(urls, index + 1);
            }
        }
        
        function disconnectWebSocket() {
            if (socket) {
                socket.close();
                socket = null;
                log('üîå WebSocket desconectado manualmente');
                updateStatus('Desconectado', 'disconnected');
            }
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        async function testHttp() {
            const hostname = window.location.hostname;
            const port = window.location.port || '80';
            
            const urls = [
                `http://${hostname}:5000/api/user`,
                `http://${hostname}/api/user`,
                `https://${hostname}/api/user`
            ];
            
            for (const url of urls) {
                try {
                    log(`üåê Testando HTTP: ${url}`);
                    const response = await fetch(url, { method: 'GET' });
                    log(`‚úÖ HTTP OK: ${url} (status: ${response.status})`);
                } catch (error) {
                    log(`‚ùå HTTP falhou: ${url} (${error.message})`);
                }
            }
        }
        
        // Inicializar
        window.onload = () => {
            log('üöÄ Teste de WebSocket inicializado');
            log(`üìç Localiza√ß√£o: ${window.location.href}`);
            testUrls();
        };
    </script>
</body>
</html>